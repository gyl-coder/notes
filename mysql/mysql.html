


<!DOCTYPE html>
<html lang="en" class="with-v3-banner">
  <head>
    <title>Notes</title>
    <meta charset="utf-8">
    <meta name="description" content="Notes - Personal review warehouse">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="alternate" hreflang="x-default" href="https://vuejs.org/mysql/mysql.html">
    <link rel="alternate" hreflang="zh" href="https://cn.vuejs.org/mysql/mysql.html">
    <link rel="alternate" hreflang="ja" href="https://jp.vuejs.org/mysql/mysql.html">
    <link rel="alternate" hreflang="ru" href="https://ru.vuejs.org/mysql/mysql.html">
    <link rel="alternate" hreflang="ko" href="https://kr.vuejs.org/mysql/mysql.html">
    <link rel="alternate" hreflang="pt-BR" href="https://br.vuejs.org/mysql/mysql.html">
    <link rel="alternate" hreflang="fr" href="https://fr.vuejs.org/mysql/mysql.html">
    <link rel="alternate" hreflang="es" href="https://es.vuejs.org/mysql/mysql.html">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Notes">
    <meta property="og:description" content="Notes - Personal review warehouse">
    <meta property="og:image" content="https://vuejs.org//images/logo.png">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Notes">
    <meta name="twitter:description" content="Notes - Personal review warehouse">
    <meta name="twitter:image" content="https://vuejs.org/images/logo.png">

    <link rel="apple-touch-icon" sizes="57x57" href="/images/icons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/images/icons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/images/icons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/images/icons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/images/icons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/images/icons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/images/icons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/images/icons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/icons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/images/icons/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/images/icons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/icons/favicon-16x16.png">
    <meta name="msapplication-TileImage" content="/images/icons/ms-icon-144x144.png">
    <link rel="icon" href="/images/logo.png" type="image/png">

    <meta name="msapplication-TileColor" content="#4fc08d">
    <meta name="theme-color" content="#4fc08d">

    <meta name="msapplication-config" content="browserconfig.xml">
    <link rel="manifest" href="/manifest.json">

    <link href="https://fonts.googleapis.com" rel="preconnect" crossorigin>
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
    <link href="https://maxcdn.bootstrapcdn.com" rel="preconnect" crossorigin>

    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Roboto Mono&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Dosis:500&text=Vue.js&display=swap" rel="stylesheet">

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- main page styles -->
    
<link rel="stylesheet" href="/css/page.css">


    <!-- this needs to be loaded before guide's inline scripts -->
    <script src="/js/vue.js"></script>

    

    <script>
      Vue.config.productionTip = false
      window.PAGE_TYPE = ""
    </script>

    <!-- ga -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-46852172-1', 'vuejs.org');
      ga('send', 'pageview');
    </script>

    <!-- vimeo analytics -->
    <script type="text/javascript" defer="defer" src="https://extend.vimeocdn.com/ga/72160148.js"></script>
  <meta name="generator" content="Hexo 5.4.0"></head>
  <body class="docs">
    <div id="mobile-bar" >
      <a class="menu-button"></a>
      <a class="logo" href="/"></a>
    </div>
    <div>
  <div id="v3-banner">
    <span class="hidden-sm">Welcome to yanliang's notes</span>
  </div>

  <header id="header">
    <a id="logo" href="/">
      <img src="/images/logo.png" alt="vue logo">
      <span>Notes - personal review warehouse</span>
    </a>
    <ul id="nav">
      <li>
  <form id="search-form">
    <input type="text" id="search-query-nav" class="search-query st-default-search-input" aria-label="Search">
  </form>
</li>
<li class="nav-dropdown-container learn">
  <a class="nav-link">⭐️Java</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><h4>Documentation</h4></li>
    <li>
      <ul>
        <li><a href="/java/oop/" class="nav-link">OOP</a></li>
        <li><a href="/v2/api/" class="nav-link">API</a></li>
        <li><a href="/v2/style-guide/" class="nav-link">Style Guide</a></li>
        <li><a href="/v2/examples/" class="nav-link">Examples</a></li>
        <li><a href="/v2/cookbook/" class="nav-link">Cookbook</a></li>
      </ul>
    </li>
    <li><h4>Video Courses</h4></li>
    <li>
      <ul>
        <li>
          <a href="https://www.vuemastery.com/courses/" class="nav-link" target="_blank" rel="sponsored noopener">
            Vue Mastery
          </a>
        </li>
        <li>
          <a
            href="https://vueschool.io/?friend=vuejs&utm_source=Vuejs.org&utm_medium=Link&utm_content=Navbar%20Dropdown"
            class="nav-link"
            target="_blank" rel="sponsored noopener"
          >
            Vue School
          </a>
        </li>
      </ul>
    </li>
  </ul>
</li>

<li class="nav-dropdown-container learn">
  <a class="nav-link">网络</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <!-- <li><h4>Documentation</h4></li> -->
    <li>
      <ul>
        <li><a href="/network">Review List</a></li>
        <li><a href="/network/tcp/">🔥TCP</a></li>
        <li><a href="/network/http/">HTTP</a></li>
        <li><a href="/network/ip/">IP</a></li>
      </ul>
    </li>
    <li><h4>Video Courses</h4></li>
    <li>
      <ul>
        <li>
          <a href="https://www.vuemastery.com/courses/" class="nav-link" target="_blank" rel="sponsored noopener">
            Vue Mastery
          </a>
        </li>
        <li>
          <a
            href="https://vueschool.io/?friend=vuejs&utm_source=Vuejs.org&utm_medium=Link&utm_content=Navbar%20Dropdown"
            class="nav-link"
            target="_blank" rel="sponsored noopener"
          >
            Vue School
          </a>
        </li>
      </ul>
    </li>
  </ul>
</li>

<li>
  <a href="/os/">操作系统</a>
</li>
<li>
  <a href="/mysql/">💼数据库</a>
</li>
<li>
  <a target="_blank" rel="noopener" href="https://codetop.cc/#/home">❤️算法</a>
</li>
<li class="nav-dropdown-container resources">
  <a href="#" class="nav-link">Resources</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/resources/partners.html" class="nav-link">Partners</a></li>
    <li><a href="/resources/themes.html" class="nav-link">Themes</a></li>
    <li><a href="https://github.com/vuejs/awesome-vue" class="nav-link" target="_blank" rel="noopener">Awesome Vue</a></li>
    <li><a href="https://awesomejs.dev/for/vue/" class="nav-link" target="_blank" rel="noopener">Browse packages for Vue</a></li>
  </ul>
</li>

<!-- <li>
  <a href="/partners" class="nav-link ">Partners</a>
</li> -->
<li class="nav-dropdown-container support-vue">
  <a href="/support-vuejs/" class="nav-link">Support Vue</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/support-vuejs/#One-time-Donations" class="nav-link">One-time Donations</a></li>
    <li><a href="/support-vuejs/#Recurring-Pledges" class="nav-link">Recurring Pledges</a></li>
    <li><a href="https://vue.threadless.com" target="_blank" rel="noopener" class="nav-link">T-Shirt Shop</a></li>
  </ul>
</li>

<li class="nav-dropdown-container language">
  <a class="nav-link">Translations</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a target="_blank" rel="noopener" href="https://cn.vuejs.org/mysql/mysql.html" class="nav-link">中文</a></li>
    <li><a target="_blank" rel="noopener" href="https://jp.vuejs.org/mysql/mysql.html" class="nav-link">日本語</a></li>
    <li><a target="_blank" rel="noopener" href="https://ru.vuejs.org/mysql/mysql.html" class="nav-link">Русский</a></li>
    <li><a target="_blank" rel="noopener" href="https://kr.vuejs.org/mysql/mysql.html" class="nav-link">한국어</a></li>
    <li><a target="_blank" rel="noopener" href="https://br.vuejs.org/mysql/mysql.html" class="nav-link">Português</a></li>
    <li><a target="_blank" rel="noopener" href="https://fr.vuejs.org/mysql/mysql.html" class="nav-link">Français</a></li>
    <li><a target="_blank" rel="noopener" href="https://vi.vuejs.org/mysql/mysql.html" class="nav-link">Tiếng Việt</a></li>
    <li><a target="_blank" rel="noopener" href="https://es.vuejs.org/mysql/mysql.html" class="nav-link">Español</a></li>
    <li><a target="_blank" rel="noopener" href="https://docs.vuejs.id/mysql/mysql.html" class="nav-link">Bahasa Indonesia</a></li>
  </ul>
</li>


    </ul>
  </header>
</div>

    
      <div id="main" class="fix-sidebar">
        
  <div class="sidebar">
    <ul class="main-menu">
      <li>
  <form id="search-form">
    <input type="text" id="search-query-sidebar" class="search-query st-default-search-input" aria-label="Search">
  </form>
</li>
<li class="nav-dropdown-container learn">
  <a class="nav-link">⭐️Java</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><h4>Documentation</h4></li>
    <li>
      <ul>
        <li><a href="/java/oop/" class="nav-link">OOP</a></li>
        <li><a href="/v2/api/" class="nav-link">API</a></li>
        <li><a href="/v2/style-guide/" class="nav-link">Style Guide</a></li>
        <li><a href="/v2/examples/" class="nav-link">Examples</a></li>
        <li><a href="/v2/cookbook/" class="nav-link">Cookbook</a></li>
      </ul>
    </li>
    <li><h4>Video Courses</h4></li>
    <li>
      <ul>
        <li>
          <a href="https://www.vuemastery.com/courses/" class="nav-link" target="_blank" rel="sponsored noopener">
            Vue Mastery
          </a>
        </li>
        <li>
          <a
            href="https://vueschool.io/?friend=vuejs&utm_source=Vuejs.org&utm_medium=Link&utm_content=Navbar%20Dropdown"
            class="nav-link"
            target="_blank" rel="sponsored noopener"
          >
            Vue School
          </a>
        </li>
      </ul>
    </li>
  </ul>
</li>

<li class="nav-dropdown-container learn">
  <a class="nav-link">网络</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <!-- <li><h4>Documentation</h4></li> -->
    <li>
      <ul>
        <li><a href="/network">Review List</a></li>
        <li><a href="/network/tcp/">🔥TCP</a></li>
        <li><a href="/network/http/">HTTP</a></li>
        <li><a href="/network/ip/">IP</a></li>
      </ul>
    </li>
    <li><h4>Video Courses</h4></li>
    <li>
      <ul>
        <li>
          <a href="https://www.vuemastery.com/courses/" class="nav-link" target="_blank" rel="sponsored noopener">
            Vue Mastery
          </a>
        </li>
        <li>
          <a
            href="https://vueschool.io/?friend=vuejs&utm_source=Vuejs.org&utm_medium=Link&utm_content=Navbar%20Dropdown"
            class="nav-link"
            target="_blank" rel="sponsored noopener"
          >
            Vue School
          </a>
        </li>
      </ul>
    </li>
  </ul>
</li>

<li>
  <a href="/os/">操作系统</a>
</li>
<li>
  <a href="/mysql/">💼数据库</a>
</li>
<li>
  <a target="_blank" rel="noopener" href="https://codetop.cc/#/home">❤️算法</a>
</li>
<li class="nav-dropdown-container resources">
  <a href="#" class="nav-link">Resources</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/resources/partners.html" class="nav-link">Partners</a></li>
    <li><a href="/resources/themes.html" class="nav-link">Themes</a></li>
    <li><a href="https://github.com/vuejs/awesome-vue" class="nav-link" target="_blank" rel="noopener">Awesome Vue</a></li>
    <li><a href="https://awesomejs.dev/for/vue/" class="nav-link" target="_blank" rel="noopener">Browse packages for Vue</a></li>
  </ul>
</li>

<!-- <li>
  <a href="/partners" class="nav-link ">Partners</a>
</li> -->
<li class="nav-dropdown-container support-vue">
  <a href="/support-vuejs/" class="nav-link">Support Vue</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/support-vuejs/#One-time-Donations" class="nav-link">One-time Donations</a></li>
    <li><a href="/support-vuejs/#Recurring-Pledges" class="nav-link">Recurring Pledges</a></li>
    <li><a href="https://vue.threadless.com" target="_blank" rel="noopener" class="nav-link">T-Shirt Shop</a></li>
  </ul>
</li>

<li class="nav-dropdown-container language">
  <a class="nav-link">Translations</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a target="_blank" rel="noopener" href="https://cn.vuejs.org/mysql/mysql.html" class="nav-link">中文</a></li>
    <li><a target="_blank" rel="noopener" href="https://jp.vuejs.org/mysql/mysql.html" class="nav-link">日本語</a></li>
    <li><a target="_blank" rel="noopener" href="https://ru.vuejs.org/mysql/mysql.html" class="nav-link">Русский</a></li>
    <li><a target="_blank" rel="noopener" href="https://kr.vuejs.org/mysql/mysql.html" class="nav-link">한국어</a></li>
    <li><a target="_blank" rel="noopener" href="https://br.vuejs.org/mysql/mysql.html" class="nav-link">Português</a></li>
    <li><a target="_blank" rel="noopener" href="https://fr.vuejs.org/mysql/mysql.html" class="nav-link">Français</a></li>
    <li><a target="_blank" rel="noopener" href="https://vi.vuejs.org/mysql/mysql.html" class="nav-link">Tiếng Việt</a></li>
    <li><a target="_blank" rel="noopener" href="https://es.vuejs.org/mysql/mysql.html" class="nav-link">Español</a></li>
    <li><a target="_blank" rel="noopener" href="https://docs.vuejs.id/mysql/mysql.html" class="nav-link">Bahasa Indonesia</a></li>
  </ul>
</li>


    </ul>
  </div>

<div class="content  ">
  <p class="tip warning v3-warning">
    Welcome to yanliang's notes.
  </p>

  
  
  
    <p>[TOC]</p>
<h2 id="Mysql-应用架构演变"><a href="#Mysql-应用架构演变" class="headerlink" title="Mysql 应用架构演变"></a>Mysql 应用架构演变</h2><p>一个简单的网站架构一般包含以下几层</p>
<p>用户请求 –&gt;应用层 –&gt; 服务层 –&gt; 存储层</p>
<ul>
<li>用户请求–&gt;应用层的优化：nginx + tomcat集群进行优化</li>
<li>应用层–&gt;服务层的优化：分布式，微服务</li>
<li>服务层–&gt;存储层：数据库存储及优化</li>
</ul>
<p>网站在不同的并发访问量和数据量级下，MySQL应用架构的演变过程。</p>
<h3 id="架构V1-0-单机单库"><a href="#架构V1-0-单机单库" class="headerlink" title="架构V1.0 - 单机单库"></a>架构V1.0 - 单机单库</h3><p>一个简单的网站或者应用，背后的架构可以非常简单，数据存储只需要一个MySQL Instance 就能满足数据读取和写入需求（这里忽略掉了数据备份的Instance），处于这个阶段的系统，一般会把所有的信息都存到一个MySQL Instance里面。</p>
<blockquote>
<p>DAL （Data Access Layer）数据访问层</p>
<p>主要功能：负责数据库的访问。简单的说就是实现对数据表的CRUD</p>
</blockquote>
<p><img src="../img/mysql/21.png" alt="image.png"></p>
<h4 id="V1-0-瓶颈"><a href="#V1-0-瓶颈" class="headerlink" title="V1.0 瓶颈"></a>V1.0 瓶颈</h4><ul>
<li>数据量太大，超出一台服务器承受能力范围</li>
<li>读写数据量太大，超出一台服务器承受能力范围</li>
<li>可用性太差，一台服务器挂掉，应用也会挂掉</li>
</ul>
<h3 id="架构V2-0-主从架构"><a href="#架构V2-0-主从架构" class="headerlink" title="架构V2.0 - 主从架构"></a>架构V2.0 - 主从架构</h3><p>V2.0 架构主要解决架构V1.0下的<strong>高可用</strong>和<strong>读扩展</strong>问题，通过给Instance挂载从库解决读取的压力，主库宕机也可以通过主从切换保障高可用。在MySQL的场景下就是通过主从结构（爽主结构也属于特殊的主从结构），主库抗写压力，通过从库来分担读压力，对于写少读多的应用，V2.0主从架构完全能够胜任。</p>
<p><img src="../img/mysql/22.png" alt="image.png"></p>
<h4 id="V2-0-瓶颈"><a href="#V2-0-瓶颈" class="headerlink" title="V2.0 瓶颈"></a>V2.0 瓶颈</h4><ul>
<li>数据量太大，超过一台服务器承受能力范围</li>
<li>写操作太多，超出一台服务器的承受能力范围</li>
</ul>
<h3 id="架构V3-0-分库分表"><a href="#架构V3-0-分库分表" class="headerlink" title="架构V3.0 - 分库分表"></a>架构V3.0 - 分库分表</h3><p>对于V1.0 和 V2.0遇到写入瓶颈和存储瓶颈时，可以通过水平拆分来解决，水平拆分和垂直拆分有较大的区别，垂直拆分完的结果，每个Instance都拥有完整的数据，而水平拆分之后，任何实例都只有全量的 1/n 的数据。下图所示，将UserInfo 拆分为3个Sharding，每个Sharding持有总量的 1/3数据，3个Sharding数据的总和等于一份完整数据。</p>
<p><img src="../img/mysql/23.png" alt="image.png"></p>
<h4 id="V3-0架构的挑战"><a href="#V3-0架构的挑战" class="headerlink" title="V3.0架构的挑战"></a>V3.0架构的挑战</h4><ul>
<li><p>数据如何路由（分片）</p>
</li>
<li><ul>
<li>范围拆分</li>
<li>List 拆分</li>
<li>Hash 拆分</li>
</ul>
</li>
<li><p>数据库一致性</p>
</li>
</ul>
<h3 id="V4-0-云数据库"><a href="#V4-0-云数据库" class="headerlink" title="V4.0 云数据库"></a>V4.0 云数据库</h3><p>云数据库（云计算）现在是各大IT公司内部作为节约成本的一个突破口，对于数据存储的MySQL来说，如何让其成为Saas（Software as a Service）是关键点。MySQL作为一个Saas服务，服务提供商负责解决可配置性，可扩展性，多用户存储结构设计等这些疑难问题。</p>
<p><img src="../img/mysql/24.png" alt="image.png"></p>
<h2 id="Mysql-基础架构"><a href="#Mysql-基础架构" class="headerlink" title="Mysql 基础架构"></a>Mysql 基础架构</h2><p><img src="../img/mysql/25.png"></p>
<h2 id="Mysql-体系架构"><a href="#Mysql-体系架构" class="headerlink" title="Mysql 体系架构"></a>Mysql 体系架构</h2><p>MySQL Server架构自顶向下大致可以分网络连接层、服务层、存储引擎层和系统文件层。</p>
<h3 id="网络连接层"><a href="#网络连接层" class="headerlink" title="网络连接层"></a>网络连接层</h3><p>客户端连接器（Client Connectors）：提供与MySQL服务器建立的支持。目前几乎支持所有主流 的服务端编程技术，例如常见的 Java、C、Python、.NET等，它们通过各自API技术与MySQL建立链接</p>
<h3 id="服务层（MySQL-Server）"><a href="#服务层（MySQL-Server）" class="headerlink" title="服务层（MySQL Server）"></a>服务层（MySQL Server）</h3><p>服务层是MySQL Server的核心，主要包含系统管理和控制工具、连接池、SQL接口、解析器、查询优 化器和缓存六个部分。</p>
<ul>
<li><p><strong>连接池（Connection Pool）：</strong>负责存储和管理客户端与数据库的连接，一个线程负责管理一个连接。</p>
</li>
<li><ul>
<li>Authentication 权限控制</li>
<li>Thread Reuse 线程复用</li>
<li>Connection Limits 连接数限制</li>
<li>Check Memory 内存检查</li>
<li>Caches 缓存</li>
</ul>
</li>
<li><p><strong>系统管理和控制工具（Management Services &amp; Utilities）：</strong>例如备份恢复、安全管理、集群 管理等 </p>
</li>
<li><p><strong>SQL接口（SQL Interface）：</strong>用于接受客户端发送的各种SQL命令，并且返回用户需要查询的结果。比如DML、DDL、存储过程、视图、触发器等。 </p>
</li>
</ul>
<blockquote>
<p>DML (Data Manipulation Language) 数据操纵语言。用户通过它可以实现对数据库的基本操作。</p>
<p>DDL</p>
</blockquote>
<ul>
<li><strong>解析器（Parser）：</strong>负责将请求的SQL解析生成一个”解析树”。然后根据一些MySQL规则进一步检查解析树是否合法。 </li>
<li><strong>查询优化器（Optimizer）：</strong>当“解析树”通过解析器语法检查后，将交由优化器将其转化成执行计 划，然后与存储引擎交互。</li>
</ul>
<blockquote>
<p>select uid,name from user where gender=1; </p>
<p>选取 –&gt; 投影 –&gt; 联接 策略 </p>
<p>1）select先根据where语句进行<strong>选取</strong>，并不是查询出全部数据再过滤 </p>
<p>2）select查询根据uid和name进行属性<strong>投影</strong>，并不是取出所有字段 </p>
<p>3）将前面选取和<strong>投影</strong>联接起来终生成查询结果 </p>
</blockquote>
<ul>
<li><strong>缓存（Cache&amp;Buﬀer）：</strong> 缓存机制是由一系列小缓存组成的。比如表缓存，记录缓存，权限缓存，引擎缓存等。如果查询缓存有命中的查询结果，查询语句就可以直接去查询缓存中取数据。</li>
</ul>
<h3 id="存储引擎层"><a href="#存储引擎层" class="headerlink" title="存储引擎层"></a>存储引擎层</h3><p>存储引擎负责MySQL中数据的存储与提取，与底层系统文件进行交互。MySQL存储引擎是插件式的， 服务器中的查询执行引擎通过接口与存储引擎进行通信，接口屏蔽了不同存储引擎之间的差异 。现在有 很多种存储引擎，各有各的特点，常见的是MyISAM和InnoDB。 </p>
<h3 id="系统文件层"><a href="#系统文件层" class="headerlink" title="系统文件层"></a>系统文件层</h3><p>该层负责将数据库的数据和日志存储在文件系统之上，并完成与存储引擎的交互，是文件的物理存储 层。主要包含日志文件，数据文件，配置文件，pid 文件，socket 文件等。</p>
<h4 id="日志文件"><a href="#日志文件" class="headerlink" title="日志文件"></a>日志文件</h4><ul>
<li><p>错误日志（Error log） </p>
</li>
<li><ul>
<li>默认开启，show variables like ‘%log_error%’ </li>
</ul>
</li>
<li><p>通用查询日志（General query log） </p>
</li>
<li><ul>
<li>记录一般查询语句，show variables like ‘%general%’; </li>
</ul>
</li>
<li><p>二进制日志（binary log） </p>
</li>
<li><ul>
<li>记录了对MySQL数据库执行的更改操作，并且记录了语句的发生时间、执行时长；但是它不 记录select、show等不修改数据库的SQL。</li>
<li>主要用于数据库恢复和主从复制。 </li>
<li>show variables like ‘%log_bin%’; //是否开启 </li>
<li>show variables like ‘%binlog%’; //参数查看 </li>
<li>show binary logs;//查看日志文件 </li>
</ul>
</li>
<li><p>慢查询日志（Slow query log）</p>
</li>
<li><ul>
<li>记录所有执行时间超时的查询SQL，默认是10秒。 </li>
<li>show variables like ‘%slow_query%’; //是否开启 </li>
<li>show variables like ‘%long_query_time%’; //时长 </li>
</ul>
</li>
<li><p>配置文件 </p>
</li>
<li><ul>
<li>用于存放MySQL所有的配置信息文件，比如my.cnf、my.ini等。 </li>
</ul>
</li>
<li><p>数据文件 </p>
</li>
<li><ul>
<li>db.opt 文件：记录这个库的默认使用的字符集和校验规则。 </li>
<li>frm 文件：存储与表相关的元数据（meta）信息，包括表结构的定义信息等，每一张表都会 有一个frm 文件。 </li>
<li>MYD 文件：MyISAM 存储引擎专用，存放 MyISAM 表的数据（data)，每一张表都会有一个 .MYD 文件。 </li>
<li>MYI 文件：MyISAM 存储引擎专用，存放 MyISAM 表的索引相关信息，每一张 MyISAM 表对 应一个 .MYI 文件。 </li>
<li>ibd文件和 IBDATA 文件：存放 InnoDB 的数据文件（包括索引）。InnoDB 存储引擎有两种 表空间方式：独享表空间和共享表空间。独享表空间使用 .ibd 文件来存放数据，且每一张 InnoDB 表对应一个 .ibd 文件。共享表空间使用 .ibdata 文件，所有表共同使用一个（或多 个，自行配置）.ibdata 文件。 </li>
<li>ibdata1 文件：系统表空间数据文件，存储表元数据、Undo日志等 。 </li>
<li>ib_logﬁle0、ib_logﬁle1 文件：Redo log 日志文件。</li>
</ul>
</li>
<li><p>pid 文件 </p>
</li>
<li><ul>
<li>pid 文件是 mysqld 应用程序在 Unix/Linux 环境下的一个进程文件，和许多其他 Unix/Linux 服务 端程序一样，它存放着自己的进程 id。 </li>
</ul>
</li>
<li><p>socket 文件 </p>
</li>
<li><ul>
<li>socket 文件也是在 Unix/Linux 环境下才有的，用户在 Unix/Linux 环境下客户端连接可以不通过 TCP/IP 网络而直接使用 Unix Socket 来连接 MySQL。 </li>
</ul>
</li>
</ul>
<h2 id="SQL-运行机制"><a href="#SQL-运行机制" class="headerlink" title="SQL 运行机制"></a>SQL 运行机制</h2><p><img src="../img/mysql/26.png"></p>
<h3 id="①建立连接"><a href="#①建立连接" class="headerlink" title="①建立连接"></a>①建立连接</h3><p>（Connectors&amp;Connection Pool），通过客户端/服务器通信协议与MySQL建立连 接。MySQL 客户端与服务端的通信方式是 “ 半双工 ”。对于每一个 MySQL 的连接，时刻都有一个 线程状态来标识这个连接正在做什么。 </p>
<p><strong>通讯机制：</strong> </p>
<p>双工：能同时发送和接收数据，例如平时打电话。 </p>
<p>半双工：指的某一时刻，要么发送数据，要么接收数据，不能同时。例如早期对讲机 </p>
<p>单工：只能发送数据或只能接收数据。例如单行道 </p>
<p><strong>线程状态：</strong></p>
<p>show processlist; //查看用户正在运行的线程信息，root用户能查看所有线程，其他用户只能看自己的 </p>
<ul>
<li><p>id：线程ID，可以使用kill xx； user：启动这个线程的用户 </p>
</li>
<li><p>Host：发送请求的客户端的IP和端口号 </p>
</li>
<li><p>db：当前命令在哪个库执行 </p>
</li>
<li><p>Command：该线程正在执行的操作命令 </p>
</li>
<li><ul>
<li>Create DB：正在创建库操作 </li>
<li>Drop DB：正在删除库操作 </li>
<li>Execute：正在执行一个PreparedStatement </li>
<li>Close Stmt：正在关闭一个PreparedStatement </li>
<li>Query：正在执行一个语句 </li>
<li>Sleep：正在等待客户端发送语句 </li>
<li>Quit：正在退出 </li>
<li>Shutdown：正在关闭服务器 </li>
</ul>
</li>
<li><p>Time：表示该线程处于当前状态的时间，单位是秒 </p>
</li>
<li><p>State：线程状态 </p>
</li>
<li><ul>
<li>Updating：正在搜索匹配记录，进行修改 </li>
<li>Sleeping：正在等待客户端发送新请求 </li>
<li>Starting：正在执行请求处理 </li>
<li>Checking table：正在检查数据表 </li>
<li>Closing table : 正在将表中数据刷新到磁盘中 </li>
<li>Locked：被其他查询锁住了记录 </li>
<li>Sending Data：正在处理Select查询，同时将结果发送给客户端 </li>
</ul>
</li>
<li><p>Info：一般记录线程执行的语句，默认显示前100个字符。想查看完整的使用show full processlist; </p>
</li>
</ul>
<h3 id="②查询缓存"><a href="#②查询缓存" class="headerlink" title="②查询缓存"></a>②查询缓存</h3><p>（Cache&amp;Buﬀer），这是MySQL的一个可优化查询的地方，如果开启了查询缓存且在 查询缓存过程中查询到完全相同的SQL语句，则将查询结果直接返回给客户端；如果没有开启查询 缓存或者没有查询到完全相同的 SQL 语句则会由解析器进行语法语义解析，并生成“解析树”。 </p>
<ul>
<li><p>缓存Select查询的结果和SQL语句 </p>
</li>
<li><p>执行Select查询时，先查询缓存，判断是否存在可用的记录集，要求是否完全相同（包括参数值），这样才会匹配缓存数据命中。 </p>
</li>
<li><p>即使开启查询缓存，以下SQL也不能缓存 </p>
</li>
<li><ul>
<li>查询语句使用SQL_NO_CACHE </li>
<li>查询的结果大于query_cache_limit设置 </li>
<li>查询中有一些不确定的参数，比如now() </li>
</ul>
</li>
<li><p>show variables like ‘%query_cache%’; //查看查询缓存是否启用，空间大小，限制等 </p>
</li>
<li><p>show status like ‘Qcache%’; //查看更详细的缓存参数，可用缓存空间，缓存块，缓存多少等</p>
</li>
</ul>
<h3 id="③解析器"><a href="#③解析器" class="headerlink" title="③解析器"></a>③解析器</h3><p>（Parser）将客户端发送的SQL进行语法解析，生成”解析树”。预处理器根据一些MySQL 规则进一步检查“解析树”是否合法，例如这里将检查数据表和数据列是否存在，还会解析名字和别名，看看它们是否有歧义，后生成新的“解析树”。 </p>
<h3 id="④查询优化器"><a href="#④查询优化器" class="headerlink" title="④查询优化器"></a>④查询优化器</h3><p>（Optimizer）根据“解析树”生成优的执行计划。MySQL使用很多优化策略生成 优的执行计划，可以分为两类：静态优化（编译时优化）、动态优化（运行时优化）。 </p>
<ul>
<li><p>等价变换策略 </p>
</li>
<li><ul>
<li>5=5 and a&gt;5 改成 a &gt; 5 </li>
<li>a &lt; b and a=5 改成b&gt;5 and a=5 </li>
<li>基于联合索引，调整条件位置等 </li>
</ul>
</li>
<li><p>优化count、min、max等函数 </p>
</li>
<li><ul>
<li>InnoDB引擎min函数只需要找索引左边 </li>
<li>InnoDB引擎max函数只需要找索引右边 </li>
<li>MyISAM引擎count(*)，不需要计算，直接返回 </li>
</ul>
</li>
<li><p>提前终止查询 </p>
</li>
<li><ul>
<li>使用了limit查询，获取limit所需的数据，就不在继续遍历后面数据 </li>
</ul>
</li>
<li><p>in的优化 </p>
</li>
<li><ul>
<li>MySQL对in查询，会先进行排序，再采用二分法查找数据。比如where id in (2,1,3)，变 成 in (1,2,3)  </li>
</ul>
</li>
</ul>
<h3 id="⑤查询执行引擎负责执行-SQL-语句"><a href="#⑤查询执行引擎负责执行-SQL-语句" class="headerlink" title="⑤查询执行引擎负责执行 SQL 语句"></a>⑤查询执行引擎负责执行 SQL 语句</h3><p>此时查询执行引擎会根据 SQL 语句中表的存储引擎类型，以 及对应的API接口与底层存储引擎缓存或者物理文件的交互，得到查询结果并返回给客户端。若开 启用查询缓存，这时会将SQL 语句和结果完整地保存到查询缓存（Cache&amp;Buﬀer）中，以后若有 相同的 SQL 语句执行则直接返回结果。 </p>
<ul>
<li>如果开启了查询缓存，先将查询结果做缓存操作 </li>
<li>返回结果过多，采用增量模式返回</li>
</ul>
<h2 id="Mysql-innodb-页结构"><a href="#Mysql-innodb-页结构" class="headerlink" title="Mysql innodb 页结构"></a>Mysql innodb 页结构</h2><p><img src="../img/mysql/28.png"></p>
<p><img src="../img/mysql/29.png"></p>
<ul>
<li>各个数据⻚可以组成⼀个双向链表 </li>
<li>⽽每个数据⻚中的记录⼜可以组成⼀个单向链表 <ul>
<li>每个数据⻚都会为存储在它⾥边⼉的记录⽣成⼀个⻚⽬录，在通过主键查找某条记录的时候可 以在⻚⽬录中使⽤⼆分法快速定位到对应的槽，然后再遍历该槽对应分组中的记录即可快速找 到指定的记录 </li>
<li>以其他列(⾮主键)作为搜索条件：只能从最⼩记录开始依次遍历单链表中的每条记录。 </li>
</ul>
</li>
</ul>
<p>所以说，如果我们写 select * from user where username=’zhangsan’ 这样没有进⾏任何优化的sql语句，默认 会这样做：</p>
<ul>
<li>定位到记录所在的⻚ 需要遍历双向链表，</li>
<li>找到所在的⻚ 从所在的⻚内中查找相应的记录 </li>
<li>由于不是根据主键查询，只能遍历所在⻚的单链表了 </li>
</ul>
<p>很明显，在数据量很⼤的情况下这样查找会很慢！看起来跟回表有点点像。</p>
<h2 id="Mysql-慢查询"><a href="#Mysql-慢查询" class="headerlink" title="Mysql 慢查询"></a>Mysql 慢查询</h2><h3 id="Mysql-什么情况会造成慢查？"><a href="#Mysql-什么情况会造成慢查？" class="headerlink" title="Mysql 什么情况会造成慢查？"></a>Mysql 什么情况会造成慢查？</h3><p><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/xw54gb1oe6fpxiggch19">https://www.infoq.cn/article/xw54gb1oe6fpxiggch19</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_39390545/article/details/109253328">https://blog.csdn.net/qq_39390545/article/details/109253328</a></p>
<p><strong>网络层面</strong></p>
<ul>
<li>网络丢包、重传等</li>
<li>网卡满（传输大字段），网络链路变长</li>
</ul>
<p><strong>IO</strong></p>
<ul>
<li>磁盘IO被其他任务占用</li>
<li>raid 卡 充放电，raid 卡重置</li>
</ul>
<p><strong>数据库层面</strong></p>
<ul>
<li>没有索引，或者没有正确使用索引</li>
<li>隐式转换（发生隐式转换时，MySQL 选择执行计划并不能利用到合适的索引而是选择全表扫描导致慢查询。）</li>
<li>数据量大（符合条件的记录数太多）</li>
<li>数据分布不均匀</li>
<li>表结构设计不合理</li>
<li>innodb 刷脏页</li>
<li>undo 没有被 purge/回收</li>
</ul>
<h2 id="大库-DDL-操作"><a href="#大库-DDL-操作" class="headerlink" title="大库 DDL 操作"></a>大库 DDL 操作</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/frog4/article/details/82702745">https://blog.csdn.net/frog4/article/details/82702745</a></p>
<h2 id="Mysql-优化"><a href="#Mysql-优化" class="headerlink" title="Mysql 优化"></a>Mysql 优化</h2><p>数据库优化维度有四个：</p>
<p>硬件、系统配置、数据库表结构、SQL及索引。</p>
<p><img src="../img/mysql/38.png"></p>
<p><strong>数据库层面问题解决思路？</strong></p>
<p>一般应急调优的思路：针对突然的业务办理卡顿，无法进行正常的业务处理，需要立马解决的场景。</p>
<p>1）show processlist；</p>
<p>2）explain  select id ,name from stu where name=’clsn’; # ALL  id name age  sex；</p>
<p>select id,name from stu  where id=2-1 函数 结果集&gt;30；show index from table；</p>
<p>3）通过执行计划判断，索引问题（有没有、合不合理）或者语句本身问题；</p>
<p>4）show status  like ‘%lock%’; # 查询锁状态</p>
<p>kill SESSION_ID;   # 杀掉有问题的session。</p>
<p>常规调优思路：针对业务周期性的卡顿，例如在每天10-11点业务特别慢，但是还能够使用，过了这段时间就好了。</p>
<p>1）查看slowlog，分析slowlog，分析出查询慢的语句；</p>
<p>2）按照一定优先级，一个一个排查所有慢语句；</p>
<p>3）分析top SQL，进行explain调试，查看语句执行时间；</p>
<p>4）调整索引或语句本身。</p>
<p><strong>数据库优化方向</strong></p>
<p>SQL优化方向：执行计划、索引、SQL改写。</p>
<p>做MySQL SQL 优化，我们要善用 EXPLAIN 查看SQL执行计划。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> xxx <span class="keyword">from</span> table_name;</span><br></pre></td></tr></table></figure>

<p><img src="../img/mysql/37.png"></p>
<ul>
<li>type列，连接类型。一个好的sql语句至少要达到range级别。杜绝出现all级别</li>
<li>key列，使用到的索引名。如果没有选择索引，值是NULL。可以采取强制索引方式</li>
<li>key_len列，索引长度</li>
<li>rows列，扫描行数。该值是个预估值</li>
<li>extra列，详细说明。注意常见的不太友好的值有：Using filesort, Using temporary</li>
</ul>
<h3 id="一些SQL优化建议"><a href="#一些SQL优化建议" class="headerlink" title="一些SQL优化建议"></a>一些SQL优化建议</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wcwen1990/p/7204739.html">https://www.cnblogs.com/wcwen1990/p/7204739.html</a></p>
<p><strong>SQL语句不要写的太复杂</strong></p>
<p>一个SQL语句要尽量简单，不要嵌套太多层。</p>
<p><strong>使用『临时表』缓存中间结果</strong></p>
<p>简化SQL语句的重要方法就是采用临时表暂存中间结果，这样可以避免程序中多次扫描主表，也大大减少了阻塞，提高了并发性能。</p>
<p><strong>使用like的时候要注意是否会导致全表扫</strong></p>
<p>有的时候会需要进行一些模糊查询比如</p>
<p>select id from table where username like ‘%hollis%’<br>关键词%hollis%，由于hollis前面用到了“%”，因此该查询会使用全表扫描，除非必要，否则不要在关键词前加%，</p>
<p><strong>尽量避免使用!=或&lt;&gt;操作符</strong></p>
<p>在where语句中使用!=或&lt;&gt;，引擎将放弃使用索引而进行全表扫描。</p>
<p><strong>尽量避免使用 or 来连接条件</strong></p>
<p><strong>在 where 子句中使用 or 来连接条件，引擎将放弃使用索引而进行全表扫描</strong></p>
<p><strong>尽量避免使用表达式、函数等操作作为查询条件</strong></p>
<p><strong>尽量避免大事务操作，提高系统并发能力</strong></p>
<p><strong>尽量避免使用游标</strong></p>
<p><strong>尽量避免使用in和not in</strong></p>
<p><strong>任何地方都不要使用 select * from t ，用具体的字段列表代替“*”，不要返回用不到的任何字段。</strong></p>
<p><strong>尽可能的使用 varchar/nvarchar 代替 char/nchar</strong></p>
<p><strong>尽量使用数字型字段，若只含数值信息的字段尽量不要设计为字符型，这会降低查询和连接的性能，并会增加存储开销。</strong></p>
<p><strong>索引并不是越多越好，索引固然可以提高相应的 select 的效率，但同时也降低了 insert 及 update 的效率</strong></p>
<p><strong>并不是所有索引对查询都有效，SQL是根据表中数据来进行查询优化的，当索引列有大量数据重复时，SQL查询可能不会去利用索引</strong></p>
<p><strong>SQL语句中IN包含的值不应过多</strong></p>
<p>MySQL对于IN做了相应的优化，即将IN中的常量全部存储在一个数组里面，而且这个数组是排好序的。但是如果数值较多，产生的消耗也是比较大的。再例如：select id from t where num in(1,2,3) 对于连续的数值，能用 between 就不要用 in 了；再或者使用连接来替换。</p>
<p><strong>SELECT语句务必指明字段名称</strong></p>
<p>SELECT *增加很多不必要的消耗（cpu、io、内存、网络带宽）；增加了使用覆盖索引的可能性；当表结构发生改变时，前断也需要更新。所以要求直接在select后面接上字段名。</p>
<p><strong>当只需要一条数据的时候，使用limit 1</strong></p>
<p>这是为了使EXPLAIN中type列达到const类型</p>
<p><strong>如果排序字段没有用到索引，就尽量少排序</strong></p>
<p><strong>如果限制条件中其他字段没有索引，尽量少用or</strong></p>
<p>or两边的字段中，如果有一个不是索引字段，而其他条件也不是索引字段，会造成该查询不走索引的情况。很多时候使用 union all 或者是union(必要的时候)的方式来代替“or”会得到更好的效果</p>
<p><strong>尽量用union all代替union</strong></p>
<p>union和union all的差异主要是前者需要将结果集合并后再进行唯一性过滤操作，这就会涉及到排序，增加大量的CPU运算，加大资源消耗及延迟。当然，union all的前提条件是两个结果集没有重复数据。</p>
<p><strong>不使用ORDER BY RAND()</strong></p>
<p>select id from <code>dynamic</code> order by rand() limit 1000;</p>
<p>上面的sql语句，可优化为</p>
<p>select id from <code>dynamic</code> t1 join (select rand() * (select max(id) from <code>dynamic</code>) as nid) t2 on t1.id &gt; t2.nidlimit 1000;</p>
<p><strong>分段查询</strong></p>
<p>在一些用户选择页面中，可能一些用户选择的时间范围过大，造成查询缓慢。主要的原因是扫描行数过多。这个时候可以通过程序，分段进行查询，循环遍历，将结果合并处理进行展示。</p>
<p><strong>避免在 where 子句中对字段进行 null 值判断</strong></p>
<p>对于null的判断会导致引擎放弃使用索引而进行全表扫描。</p>
<p><strong>不建议使用%前缀模糊查询</strong></p>
<p>例如LIKE “%name”或者LIKE “%name%”，这种查询会导致索引失效而进行全表扫描。但是可以使用LIKE “name%”。</p>
<p><strong>使用全文索引来查询 “%name”</strong></p>
<p><strong>避免在where子句中对字段进行表达式操作</strong></p>
<p>select user_id,user_project from user_base where age*2=36;</p>
<p>中对字段就行了算术运算，这会造成引擎放弃使用索引，建议改成</p>
<p>select user_id,user_project from user_base where age=36/2;</p>
<p><strong>对于联合索引来说，要遵守最左前缀法则</strong></p>
<p><strong>必要时可以使用force index来强制查询走某个索引</strong></p>

  
  
  <div class="footer">
      <script src="//m.servedby-buysellads.com/monetization.js" type="text/javascript"></script>
<div id="bsa-native"></div>
<script>
_bsa.init('custom', 'CKYD62QM', 'placement:vuejsorg',
  {
    target: '#bsa-native',
    template: '<a class="native-box" href="##statlink##"><div class="native-sponsor">Sponsor</div><div class="native-text"><strong>##company##</strong> — ##description##</div></a>'
  }
);
</script>


    Caught a mistake or want to contribute to the documentation?
    <a href="https://github.com/vuejs/vuejs.org/blob/master/src/mysql/mysql.md" rel="noopener" target="_blank">
      Edit this on GitHub!
    </a>
    <!-- Deployed on
    <a href="https://url.netlify.com/HJ8X2mxP8" rel="noopener" target="_blank">
      Netlify
    </a>. -->
  </div>
</div>

      </div>
      <script src="/js/smooth-scroll.min.js"></script>
    

    <!-- main custom script for sidebars, version selects etc. -->
    <script src="/js/css.escape.js"></script>
    <script src="/js/common.js"></script>

    <!-- search -->
    <link href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css" rel='stylesheet' type='text/css'>
    
<link rel="stylesheet" href="/css/search.css">

    <script src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
    <script>
    [
      '#search-query-nav',
      '#search-query-sidebar',
      '#search-query-menu'
    ].forEach(function (selector) {
      if (!document.querySelector(selector)) return
      // search index defaults to v2
      var match = window.location.pathname.match(/^\/(v\d+)/)
      var version = match ? match[1] : 'v2'
      docsearch({
      appId: 'BH4D9OD16A',
      apiKey: '85cc3221c9f23bfbaa4e3913dd7625ea',
      indexName: 'vuejs',
      inputSelector: selector,
      algoliaOptions: { facetFilters: ["version:" + version] },
      autocompleteOptions: { hint: false, appendTo: 'body'}
      })
    })
    </script>
  </body>
</html>
